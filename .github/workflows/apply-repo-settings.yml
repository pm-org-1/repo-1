name: Apply Repo Settings
on:
    workflow_dispatch:
        inputs:
            repos:
                description: 'Comma-separated list of repo names (e.g. repo1, repo2)'
                required: true

jobs:
    configure-repo:
        runs-on: ubuntu-latest #[self-hosted, bolt-ubuntu]
        steps:
        - name: Generate GitHub Access Token
          id: generate_token
          uses: actions/create-github-app-token@v2
          with:
            app-id: ${{ secrets.APP_ID }}
            private-key: ${{ secrets.APP_PEM }}
            owner: pm-org-1 #pfizer-analytics

        - name: Configure Repository Settings
          uses: actions/github-script@v7
          with:
            github-token: ${{ steps.generate_token.outputs.token }}
            script: |
                const owner = context.repo.owner;
                console.log(`owner: ${owner}`);
                
                const reposInput = `${{ github.event.inputs.repos }}` || '';
                console.log(`repos Input: ${reposInput}`);
                if (!reposInput.trim()) {
                    console.log('No repository names provided. Exiting.');
                    return;
                }
                const repos = reposInput.split(',').map(r => r.trim()).filter(Boolean);
                console.log(`Input repos: ${repos.length === 1 ? repos[0] : repos.join(', ')}`);

                const fs = require('fs');
                for (const repo of repos) {
                    console.log(`Applying settings to ${owner}/${repo}...`);
                    // 1. Update repository settings
                    let response = await github.request('PATCH /repos/{owner}/{repo}', {
                        owner,
                        repo,
                        allow_squash_merge: true,
                        delete_branch_on_merge: true,
                        allow_auto_merge: false,
                        squash_merge_commit_title: 'PR_TITLE',
                        squash_merge_commit_message: 'PR_BODY'
                    });
                    console.log(`repository settings Response status: ${response.status}`);



                    // 3. Ensure pr-title-check.yml exists
                    let prTitleCheckExists = false;
                    try {
                        let response =await github.request('GET /repos/{owner}/{repo}/contents/.github/workflows/pr-title-check.yml', {
                            owner,
                            repo
                        });
                        console.log(`check pr-title-check.yml existence Response status: ${response.status}`);
                        prTitleCheckExists = true;
                    } catch (e) {
                        prTitleCheckExists = false;
                    }

                    if (!prTitleCheckExists) {
                        // Create pr-title-check.yml in the repo
                        const prTitleCheckYml = fs.readFileSync('.github/workflows/templates/pr-title-check.yml', 'utf8');

                        let response = await github.request('PUT /repos/{owner}/{repo}/contents/.github/workflows/pr-title-check.yml', {
                            owner,
                            repo,
                            path: '.github/workflows/pr-title-check.yml',
                            message: 'Add pr-title-check workflow',
                            content: Buffer.from(prTitleCheckYml).toString('base64'),
                            committer: {
                                name: 'github-actions[bot]',
                                email: 'praveena.m@pfizer.com'
                            },
                            author: {
                                name: 'github-actions[bot]',
                                email: 'praveena.m@pfizer.com'
                            },
                            signoff: true // -S
                        });
                        console.log(`Created pr-title-check.yml in ${owner}/${repo}, Response status: ${response.status}`);
                    }

                    // 4. Branch protection rules for main and dev branches
                    for (const branch of ['main', 'dev']) {
                        let response = await github.request('PUT /repos/{owner}/{repo}/branches/{branch}/protection', {
                            owner,
                            repo,
                            branch,
                            required_linear_history: true,
                            enforce_admins: true,
                            required_pull_request_reviews: {
                                require_code_owner_reviews: true,
                                require_last_push_approval: true
                            },
                            required_conversation_resolution: true,
                            required_status_checks: {
                                strict: true,
                                contexts: ['validate-pr-title']
                            },
                            restrictions: null,
                            allow_force_pushes: false,
                            required_signatures: true
                        });
                        console.log(`Branch protection applied to ${owner}/${repo} on branch ${branch}, Response status: ${response.status}`);
                    }

                    console.log(`Settings applied to ${owner}/${repo}`);
                }